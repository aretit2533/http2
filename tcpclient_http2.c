/* 
 * tcpclient.c - A simple TCP client
 * usage: tcpclient <host> <port>
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h> 
#include <fcntl.h>
#include <errno.h>
#include <sys/select.h>

#define BUFSIZE 102400

#include "http2.h"
#include "linklist.h"

char read_buff[BUFSIZE];
char hex_buff[BUFSIZE];

/* 
 * error - wrapper for perror
 */
void error(char *msg) {
    perror(msg);
    exit(0);
}

void print_hex(char *data, int len, char *buff)
{
    int i = 0;
    int b_len = 0;
    for(i = 0; i < len; i++)
    {
        b_len += sprintf(buff + b_len, "%02x ", (data[i] & 0xff));
    }
}

void create_msg(STREAM_INFO *info, unsigned int set, unsigned int curr)
{
    char err[1024];
    http2_add_header(info, ":authority", "www.example.com", err);
    http2_add_header(info, ":method", "POST", err);
    http2_add_header(info, ":path", "/", err);
    http2_add_header(info, ":scheme", "http", err);
    http2_add_header(info, "user-agent", "Equinox-HTTP2-Ngine-v.1.0.0", err);
    http2_add_header(info, "accept-encoding", "gzip, deflate", err);
    http2_add_header(info, "accept", "*/*", err);
    http2_add_header(info, "www-authenticate", "Basic", err);
    //http2_add_header(info, "Equinox-server-version", "1.5.1", err);
    
    http2_add_data(info, "1234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101012345678910101010123456789101010101234567891010101010891010101012345678910101010123456789101010101089101010101234567891010101012345678910101010108910101010123aaaaaaaaaaaaaaaaaaaaaaaaaaa", (set - curr > 16384)? 16384: set - curr, err);
    
    http2_create_msg(info, 1, err);
}
//index.html
int main(int argc, char **argv) {
    int sockfd, portno, n, r, wflag = 0 ;
    struct sockaddr_in serveraddr;
    struct hostent *server;
    char *hostname;
    char buf[10240];
    fd_set rfd,wfd;
    int max_connection = 1000;
    
    http2_init();
        
    struct timeval tv;
    FD_ZERO(&wfd);
    FD_ZERO(&rfd);
    
    tv.tv_sec = 1;
    tv.tv_usec = 0;
    /* check command line arguments */
    if (argc != 3) {
       fprintf(stderr,"usage: %s <hostname> <port>\n", argv[0]);
       exit(0);
    }
    hostname = argv[1];
    portno = atoi(argv[2]);

    /* socket: create the socket */
    sockfd = socket(AF_INET, SOCK_STREAM, 0);
    if (sockfd < 0) 
        error("ERROR opening socket");
    
    /*ff = fcntl(sockfd, F_GETFL, 0);
    fcntl(sockfd, F_SETFL, ff | O_NONBLOCK);*/
    /* gethostbyname: get the server's DNS entry */
    server = gethostbyname(hostname);
    if (server == NULL) {
        fprintf(stderr,"ERROR, no such host as %s\n", hostname);
        exit(0);
    }

    /* build the server's Internet address */
    bzero((char *) &serveraddr, sizeof(serveraddr));
    serveraddr.sin_family = AF_INET;
    bcopy((char *)server->h_addr, 
	  (char *)&serveraddr.sin_addr.s_addr, server->h_length);
    serveraddr.sin_port = htons(portno);

    /* connect: create a connection with the server */
    if (connect(sockfd, (struct sockaddr *)&serveraddr, sizeof(serveraddr)) < 0){}
      //error("ERROR connecting");
    struct sockaddr_in sin;
    bzero((char *) &sin, sizeof(sin));
    socklen_t len = sizeof(sin);
    if (getsockname(sockfd, (struct sockaddr *)&sin, &len) == -1)
        perror("getsockname");
    else
    {
        char buff[256];
        inet_ntop(AF_INET, &(sin.sin_addr), buff, sizeof(buff)-1);
        printf("Address number %s\n", buff);
        printf("port number %d\n", ntohs(sin.sin_port));
        
    }
    printf("Sock is %d\n", sockfd);
    int seq = 0;
    
    HTTP2_CONNECTION *conn = http2_conn_init(HTTP2_MODE_CLIENT, sockfd, 0, NULL, NULL, NULL,NULL,(unsigned int *)&(max_connection),NULL,NULL,NULL,buf);
    http2_build_setting(conn, conn->http2_settings_send, NULL);
    
    FD_SET(conn->sock, &wfd);
    FD_SET(conn->sock, &rfd);
    int is_ready = 0;
    
    while(1)
    {
        FD_SET(conn->sock, &rfd);
        FD_SET(conn->sock, &wfd);
        r = select (conn->sock +1, &rfd, &wfd, NULL, &tv);
        if(FD_ISSET(conn->sock, &wfd)){
            /* get message line from the user */
            //if(seq >= 1)FD_CLR(conn->sock, &wfd);
            STREAM_INFO *info = NULL; 
            if(is_ready) info = http2_init_stream_info_send(conn, HTTP2_ID_CLIENT_INIT, buf);
            if(!info)
            {
                FD_CLR(conn->sock, &wfd);
            } else {
                create_msg(info, conn->http2_settings_recv[SETTINGS_INITIAL_WINDOW_SIZE].setting_value, conn->http2_settings_recv[SETTINGS_INITIAL_WINDOW_SIZE].current_value);
            }
            int w = 1;
            while(http2_need_write(conn) && w > 0)
            {
                /* send the message line to the server */
                w = http2_write(conn, buf);
            }
            //http2_stream_info_destroy(&info);
        }
        if(FD_ISSET(conn->sock, &rfd)){
            printf("Read--------------\n");
            n = http2_read(conn, read_buff);
            if (n < 0) {
                goto exit_loop;
            }
            STREAM_INFO *infox = NULL;
decode_again:
            infox = NULL;
            n = http2_decode(conn, &infox, (int *)&len, read_buff);
            switch(n)
            {
                case HTTP2_RETURN_SUCCESS:
                if(infox->data_recv.stream_flag & FLAG_ENDSTREAM_TRUE) {
                    http2_stream_info_destroy(&infox, 0, "");
                }
                case HTTP2_RETURN_SKIP_DATA:
                case HTTP2_RETURN_NEED_NEXT_DATA:
                goto decode_again;
                break;
                case HTTP2_RETURN_CONNECTION_CLOSE:
                goto exit_loop;
                break;
                default:
                break;
            }
            //HTTP2_HEADER *hh = NULL;
            is_ready = 1;
            FD_SET(conn->sock, &wfd);
            /*while(infox && infox->data_recv.first_header_list)
            {
                POP_HEADER(infox->data_recv.first_header_list, hh);
                printf("Header name [%s] value [%s]\n", hh->name, hh->value);
                free(hh);
            }
            http2_stream_info_destroy(&infox, 0, "");*/
        }
    }
exit_loop:
    printf("Exit: %s\n", read_buff);
    printf("WINDOW SETTING VALUE: %u\n", conn->http2_settings_recv[SETTINGS_INITIAL_WINDOW_SIZE].setting_value);
    printf("WINDOW CURRENT VALUE: %u\n", conn->http2_settings_recv[SETTINGS_INITIAL_WINDOW_SIZE].current_value);
    http2_destroy(&conn);
    
    close(sockfd);
    return 0;
}